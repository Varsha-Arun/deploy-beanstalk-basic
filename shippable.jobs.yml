jobs:
  - name: deploy-beanstalk-basic_runCI
    type: runCI
    flags:
      - deploy-eb-basic
    steps:
      - OUT: deploy-eb-basic-image

  - name: deploy-eb-basic-deploy
    type: runCLI
    flags:
      - deploy-eb-basic
    steps:
      - IN: deploy-eb-basic-image
      - IN: deploy-eb-basic-config
        switch: off
      - IN: deploy-eb-env-params
        switch: off
      - IN: deploy-eb-basic-repo
        switch: off
      - TASK:
        - script: cd $DEPLOYEBBASICREPO_STATE
        - script: shippable_replace Dockerrun.aws.json
        - script: cat Dockerrun.aws.json
        - script: "echo 'about to ebinit'"
        #- script: init_cmd="echo \"\" | eb init ${DEPLOYEBENVPARAMS_PARAMS_AWS_EB_APPLICATION} -r ${DEPLOYEBBASICCONFIG_POINTER_REGION} -p \"\" --keyname = dr-kp-us-east"
        - script: init_cmd="eb init ${DEPLOYEBENVPARAMS_PARAMS_AWS_EB_APPLICATION} -r ${DEPLOYEBBASICCONFIG_POINTER_REGION} -p \"\" --keyname = dr-kp-us-east"
        - script: "echo \"the command is: $init_cmd\""
        - script: eval $init_cmd
        #- script: eb init ${DEPLOYEBENVPARAMS_PARAMS_AWS_EB_APPLICATION} -r ${DEPLOYEBBASICCONFIG_POINTER_REGION} --keyname dr-kp-us-east
        - script: "echo 'done with ebinit'"
        - script: git add -A
        - script: "echo 'about to ebdeploy'"
        - script: eb deploy --staged ${DEPLOYEBENVPARAMS_PARAMS_AWS_EB_ENVIRONMENT}
        - script: "echo 'done with ebdeploy'"
